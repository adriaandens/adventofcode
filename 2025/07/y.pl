use v5.40;

my $sr = 0;
my $sc = 0;
my @map = ();
while(<DATA>) {
	chomp;
	if($_ !~ /S/) {
		my @r = split //;
		push @map, \@r;
	} else {
		my @r = split //;
		push @map, \@r;
		foreach(@r) {
			if($_ ne 'S') { $sc++ } else { last; }
		}
	}
}
say "S is at $sr $sc";

my %memo = (); # key: startpoint (position after a split, so left or right from ^), value: how many unique paths it has.
my $total = launch_beam("$sr#$sc", $sr, $sc);
say "Solution: $total";

sub launch_beam {
	my ($path, $s, $c) = @_;
	while($s+1 < @map && $map[$s+1][$c] eq '.' ) {
		$path .= '#' . ($s+1) . '#' . $c; # We went one down so update our path taken
		$s++;
	}
	if($s+1 < @map && $map[$s+1][$c] eq '^') {
		say "world splitting beams at " . ($s+1) . " $c";
		my $path_total = 0;
		if($c > 0) { # we can go left from here
			if(!defined($memo{($s+1) . '#' . ($c-1)})) { # we haven't taken this path yet
				my $paths_from_this_beam = launch_beam($path . '#' . ($s+1) . '#' . ($c-1), $s+1, $c-1);
				$memo{($s+1) . '#' . ($c-1)} = $paths_from_this_beam;
				$path_total += $paths_from_this_beam;
			} else {
				$path_total += $memo{($s+1) . '#' . ($c-1)};
			}
		}
		if($c < @{$map[0]}-1) { # we can go right from here
			if(!defined($memo{$path . '#' . ($s+1) . '#' . ($c+1)})) {
				my $paths_from_this_beam = launch_beam($path . '#' . ($s+1) . '#' . ($c+1), $s+1, $c+1);
				$memo{($s+1) . '#' . ($c+1)} = $paths_from_this_beam;
				$path_total += $paths_from_this_beam;
			} else {
				$path_total += $memo{($s+1) . '#' . ($c+1)};
			}
		}
		return $path_total;
	}
	if($s+1 == @map) { # we're at the bottom...
		return 1; # this path ends here
	}
}

__DATA__
......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^...^....................................................................
.............................................................................................................................................
...................................................................^...^.^...................................................................
.............................................................................................................................................
..................................................................^.^...^.^..................................................................
.............................................................................................................................................
.................................................................^.^.^.^.^.^.................................................................
.............................................................................................................................................
................................................................^.^...^...^.^................................................................
.............................................................................................................................................
...............................................................^.^.^...^.^.^.^...............................................................
.............................................................................................................................................
..............................................................^...^.^.....^.^.^..............................................................
.............................................................................................................................................
.............................................................^...^.^...^.....^.^.............................................................
.............................................................................................................................................
............................................................^.^.....^.^.^...^...^............................................................
.............................................................................................................................................
...........................................................^.^.^.....^.^.^.^.^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^.^.^.^.^.^.......^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^.^.^...^.^.^.^...^.........................................................
.............................................................................................................................................
........................................................^.^.^...^...^.^.^.^.^.^.^.^.^........................................................
.............................................................................................................................................
.......................................................^.^...^.^.^.^.^...^.^.^.^.....^.......................................................
.............................................................................................................................................
......................................................^...^.^...^.^.^.^.^.^...^...^.^.^......................................................
.............................................................................................................................................
.....................................................^.^.^.^...^...^.^.^.^.^.^.^.^.....^.....................................................
.............................................................................................................................................
....................................................^.....^.^.....^.^...^.^.^...^.^...^.^....................................................
.............................................................................................................................................
...................................................^...^.....^.^...^.^.^.^...^.^.^.^...^.^...................................................
.............................................................................................................................................
..................................................^.^.^.^...^.......^.....^.^.^.....^...^.^..................................................
.............................................................................................................................................
.................................................^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.................................................
.............................................................................................................................................
................................................^.^...^.^.^...^.^...^...^.^...^.....^.....^.^................................................
.............................................................................................................................................
...............................................^.^.^...^...^.^.^.....^.^.^.^.^.^.^.^.^.^.....^...............................................
.............................................................................................................................................
..............................................^...^.^.^.^.^.^.^.^.....^.^.^.^.^.^...^.^.^.^...^..............................................
.............................................................................................................................................
.............................................^.^.^.^.^.^...^.^.^.....^...^.^.^...^.^.^...^...^.^.............................................
.............................................................................................................................................
............................................^...^.^.^.^...^...^...^.^.^.....^.^.........^.^.....^............................................
.............................................................................................................................................
...........................................^...^.^.^.^.^.^.^.^...^...^.^.^.^.....^.^.^.^.^...^...^...........................................
.............................................................................................................................................
..........................................^...^.^...^...^...^...^.^...^.....^.^.^.^...^.^.^.^.^.^.^..........................................
.............................................................................................................................................
.........................................^.........^...^...^...^...^...^.^...^.^.^.......^...^...^.^.........................................
.............................................................................................................................................
........................................^.^.^.^.^...^...^.^.^.....^...^.^...^...^...^.....^.^...^.^.^........................................
.............................................................................................................................................
.......................................^.....^.^.^...^.^.......^.^...^...^.^.^.^.......^...^.^.^.^.^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^...^...^.^.^.^.^...^.^.^.......^.^.....^.^.^.....^.^.^.^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.^.....^.^.^.^.......^...^...^.^.^...^.^.^.^.^.^...^.^.^.^.....................................
.............................................................................................................................................
....................................^...^.^.^.^.^.....^...^.....^.^.....^.^.^.^.^.^.^.^...^.....^.^.^.^.^....................................
.............................................................................................................................................
...................................^...^...^...^.^...^.^.^.^...^...^.......^.^...^.^.^.^.^...^.^.....^...^...................................
.............................................................................................................................................
..................................^.^.^.^.^.^.....^.^.^.^.^...^...^.......^.^...^...^.^.^.^.^.^.^.^...^.^.^..................................
.............................................................................................................................................
.................................^.^...^.........^.....^.^.....^.....^.^.^.^.^.^.......^...^.^.^...^.^.^...^.................................
.............................................................................................................................................
................................^.^.^.....^.^...^...^.^.....^...^...^...^.....^.^.^.^...^.^.^...^...^.^.^.^.^................................
.............................................................................................................................................
...............................^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^.^.............^.^.....^.^...^...^.^.^.^.^...............................
.............................................................................................................................................
..............................^.......^.^.^.^...^.^.^.^.....^.^.^.^.^...^.....^.^...^...^.^.^.^.^.^.^.....^.^.^..............................
.............................................................................................................................................
.............................^.....^.^.^.^...^.^.^...^...^.^.^.^.^...^.^.^.^.^.^.^.^...^...^.^...^.^...^.^.^.^.^.............................
.............................................................................................................................................
............................^.....^.^.^...^...^...^.^.^.^...^.^.....^.^.^.....^.^...^.^...^.....^...^.^.^.^.....^............................
.............................................................................................................................................
...........................^.^...^...^.^.^.^...^...^.^...^.^.^...^.^.^...^.^.^.....^.^.^.^.^.^...^.^.....^.^.^...^...........................
.............................................................................................................................................
..........................^...^.....^...^.^.^...^...^.^.^.^.^.^...^.^.^...^.^...^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^..........................
.............................................................................................................................................
.........................^.^.....^.^.^.....^.^.^.^.^.^.^.^...^...^.^.....^...^.^.^.....^.^.^...^.^.^...^.^...^.^...^.........................
.............................................................................................................................................
........................^.^.^...^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^...^.^...^.^.^.^.....^.^.^.^.^...^...^...^.^.....^........................
.............................................................................................................................................
.......................^.^...^.^.^...^...^...^.^.^.^.....^.^.^...^.....^...^.^.^.^...^...^.^.....^.^.^.^.^.^.^.^...^.^.......................
.............................................................................................................................................
......................^.^.^.^.^...^...^.^.^...^.^.^...^...^.^.....^.^.....^.^.^.^...^.^.^.^.^.^...^.^...^...^.^.....^.^......................
.............................................................................................................................................
.....................^...^.....^...^...^.^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^.......^...^.....................
.............................................................................................................................................
....................^.^.^.....^.^.^...^.^...^.^.^.^.^.....^...^...^.^.....^.^.^.^...^.^...^...^...^.^.^.^.^...^.......^.^....................
.............................................................................................................................................
...................^...^.^.^.^.^.^...^.^.^...^...^.^.^.^.^.^.....^.^.......^.....^...^.^...^.^...^...^.^.^.^.^...^.^...^.^...................
.............................................................................................................................................
..................^.^.^.^.^.^.^.^.^.....^.........^.^.....^.^.^.^.^.^.^.^...^...^.^...^...^...^...^.......^...^.^.^...^...^..................
.............................................................................................................................................
.................^.^.^.^...^.^.^.^.......^.^...^.^.^.^.^...^...^.^...^.....^.^...^.^.^.^.....^.^.^.....^.^.......^.^.^.^.^.^.................
.............................................................................................................................................
................^.^.^...........^.......^.^.^.^...^.^.^...^.......^.^...^.....^.^.^...^.^.^.^...^.^.^.....^.^.^.^.^.....^.^.^................
.............................................................................................................................................
...............^.^.^.^.^.^.^...^.........^.^.^.^.^.^.^...^.^.....^.....^.^.^.^.^.^.^...^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^...............
.............................................................................................................................................
..............^...^.^.^.^.^...^.^.^.^.^.^...^.....^.^.^...^.^...^.^.^.^.^...^.^.^.....^.....^.....^.^.......^.^.....^.^.^.....^..............
.............................................................................................................................................
.............^.^...^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.........^.^.....^.^.....^.^.^...^.............
.............................................................................................................................................
............^...^.^.^.^...^.......^.^...^.^.^.^...^.^.....^.^.^.^.....^.^.^.....^.^.^.^...^.^.^.....^.....^.^...^.^.^.^.^...^...^............
.............................................................................................................................................
...........^.^...^...^.^.^...^.^.^.......^.^.^.......^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^...^.......^.^...^...^.^...^.^.^.^.^.^.^...........
.............................................................................................................................................
..........^...^...^...^.^.^.^...^.....^.^...^.....^.^.^.^...^.^...^.^...^.^.^.^...^.^.^.......^...^.^.....^...^.^.^.^...^.^.^.^.^.^..........
.............................................................................................................................................
.........^.^.^...^.^.^.^...^...^.^...^.^.^.^.^...^...^.^.^...^...^.^.^.^.^.....^.^.^.^.^.^.^.^.....^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.........
.............................................................................................................................................
........^.^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^...^.^.....^...^...^.^.^...^...^.....^.^.^.^.^.^.^.^........
.............................................................................................................................................
.......^.^.....^.^.^.^...^.^.......^.........^.^.^.^.^.^.^.^.^...^...^.^.^.^.^.^...^.^.^.^.^...^.^...^...^.^.^.^.^.^.....^.^.^.^.^.^.^.......
.............................................................................................................................................
......^...^.^.^.^.^...^.^.^.....^.^.........^.....^.^.^...^...^.^.^...^.^.^.^...^.....^.^.^.^.^.^.^.......^...^.....^.^.^.^.^.....^.^.^......
.............................................................................................................................................
.....^...^.^...^.^.....^.^.^.^.^.....^.^.^.^.^.^.^.^.......^.^...^.^.^.^.^.....^.^.^...^...^.^.^.^...^...^.^.^...^.......^.^.^...^.^.^.^.....
.............................................................................................................................................
....^.^.^.^.^.^.....^.^...^...^.^.^.^...^...^.^...^...^.....^.^.^.^.^.^.....^.......^.^.^.^.^.^.^.^...^.^.......^...^...^.^.^.^...^.^.^.^....
.............................................................................................................................................
...^.^.^...^.^.^.^.^...^.^.^...^.^.......^.^.^.^...^.^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^.^.....^.........^.......^.^...^.^.^.^.^.^.^.^.^.^...
.............................................................................................................................................
..^.^.^...^.^.^.^...^...^.^...^...^...^.^.^.^.....^.^...^.....^...^.^...^.^.^.^.^...^...^...^.^.^.^.^.^...^...^.^.^.....^.^.^.^.....^.^.^.^..
.............................................................................................................................................
.^.....^.^.^.^.^.^.......^.^.....^.^.^.^.^.^...^.......^.^.....^.^.^...^.^...^.^.....^.^...^.^...^.^...........^.^.^.^...^.^.....^...^.....^.
.............................................................................................................................................
